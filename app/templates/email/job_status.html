{% extends "layouts/base.html" %}
{% block title %}Job Status{% endblock %}

{% block head %}
<!-- Socket.IO JavaScript client -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block content %}
{% set show_download = job.status == 'completed' and job.job_type == 'export' and job.result_data and job.result_data.history_id %}
<div class="container mt-4">
    <h2><i class="bi bi-gear-fill"></i> Job Status - Real-time Monitoring</h2>
    <div class="card mt-4">
        <div class="card-header"><h5>Job: <span id="job-type">{{ job.job_type|title }}</span></h5></div>
        <div class="card-body">
            <p><strong>Status:</strong> 
                <span id="job-status" class="badge bg-{{ 'success' if job.status == 'completed' else 'primary' if job.status == 'running' else 'warning' if job.status == 'paused' else 'danger' if job.status == 'failed' else 'secondary' if job.status == 'cancelled' else 'warning' }}">
                    {{ job.status|upper }}
                </span>
                <span id="connection-status" class="badge bg-secondary ms-2" style="display: none;">
                    <i class="bi bi-wifi"></i> Connected
                </span>
            </p>
            <p id="progress-text"><strong>Progress:</strong> <span id="job-processed">{{ job.processed }}</span> / <span id="job-total">{{ job.total }}</span> (<span id="job-percent">{{ job.progress_percent|round(1) }}</span>%)</p>
            <div class="progress mb-3" style="height: 30px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: {{ job.progress_percent }}%; transition: width 0.3s ease-in-out;"
                     aria-valuenow="{{ job.progress_percent }}"
                     aria-valuemin="0"
                     aria-valuemax="100">
                    <span id="progress-bar-text">{{ job.progress_percent|round(1) }}%</span>
                </div>
            </div>
            
            <!-- Job Control Buttons -->
            {% if job.status in ['running', 'paused'] %}
            <div class="btn-group mb-3" role="group" id="job-controls">
                {% if job.status == 'running' %}
                <button type="button" class="btn btn-warning" id="pause-btn" onclick="pauseJob()">
                    <i class="bi bi-pause-fill"></i> Pause
                </button>
                {% elif job.status == 'paused' %}
                <button type="button" class="btn btn-success" id="resume-btn" onclick="resumeJob()">
                    <i class="bi bi-play-fill"></i> Resume
                </button>
                {% endif %}
                <button type="button" class="btn btn-danger" id="cancel-btn" onclick="cancelJob()">
                    <i class="bi bi-x-circle-fill"></i> Cancel
                </button>
            </div>
            {% endif %}
            
            <div id="live-message" class="alert alert-info" style="display: none;">
                <i class="bi bi-info-circle"></i> <span id="message-text"></span>
            </div>
            
            {% if job.result_message %}
            <p id="result-message"><strong>Result:</strong> {{ job.result_message }}</p>
            {% else %}
            <p id="result-message" style="display: none;"><strong>Result:</strong> <span id="result-text"></span></p>
            {% endif %}
            
            {% if job.error_message %}
            <div class="alert alert-danger" id="error-message">{{ job.error_message }}</div>
            {% else %}
            <div class="alert alert-danger" id="error-message" style="display: none;"><span id="error-text"></span></div>
            {% endif %}
            
            {% if show_download %}
            <div class="alert alert-success mt-3" id="download-alert">
                <i class="bi bi-check-circle-fill"></i> Export completed successfully! You can download the file now.
            </div>
            {% else %}
            <div class="alert alert-success mt-3" id="download-alert" style="display: none;">
                <i class="bi bi-check-circle-fill"></i> Export completed successfully! You can download the file now.
            </div>
            {% endif %}
            
            <div class="mt-3">
                <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">Back to Dashboard</a>
                {% if job.batch_id %}
                <a href="{{ url_for('email.batch_detail', batch_id=job.batch_id) }}" class="btn btn-primary">View Batch</a>
                {% endif %}
                {% if show_download %}
                <a href="{{ url_for('email.download_export', history_id=job.result_data.history_id) }}" class="btn btn-success" id="download-btn">
                    <i class="bi bi-download"></i> Download Export
                </a>
                {% else %}
                <a href="#" class="btn btn-success" id="download-btn" style="display: none;">
                    <i class="bi bi-download"></i> Download Export
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    const jobId = '{{ job.job_id }}';
    const jobStatus = '{{ job.status }}';
    
    // Job control functions
    async function pauseJob() {
        try {
            const response = await fetch(`/api/job/${jobId}/pause`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('message-text').textContent = 'Pause requested... waiting for safe pause point';
                document.getElementById('live-message').style.display = 'block';
            } else {
                alert('Failed to pause job: ' + data.error);
            }
        } catch (error) {
            console.error('Error pausing job:', error);
            alert('Error pausing job');
        }
    }
    
    async function resumeJob() {
        try {
            const response = await fetch(`/api/job/${jobId}/resume`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById('resume-btn').disabled = true;
                document.getElementById('message-text').textContent = 'Resuming...';
                document.getElementById('live-message').style.display = 'block';
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Failed to resume job: ' + data.error);
            }
        } catch (error) {
            console.error('Error resuming job:', error);
            alert('Error resuming job');
        }
    }
    
    async function cancelJob() {
        if (!confirm('Are you sure you want to cancel this job? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/job/${jobId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const data = await response.json();
            if (data.success) {
                document.getElementById('cancel-btn').disabled = true;
                document.getElementById('message-text').textContent = 'Cancel requested...';
                document.getElementById('live-message').style.display = 'block';
            } else {
                alert('Failed to cancel job: ' + data.error);
            }
        } catch (error) {
            console.error('Error cancelling job:', error);
            alert('Error cancelling job');
        }
    }
    
    // Connect to Socket.IO server
    const socket = io('/jobs', {
        transports: ['websocket', 'polling']
    });
    
    socket.on('connect', function() {
        console.log('Connected to real-time updates');
        document.getElementById('connection-status').style.display = 'inline-block';
        document.getElementById('connection-status').classList.remove('bg-secondary');
        document.getElementById('connection-status').classList.add('bg-success');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from real-time updates');
        document.getElementById('connection-status').classList.remove('bg-success');
        document.getElementById('connection-status').classList.add('bg-secondary');
    });
    
    // Throttle progress updates to prevent jerky animation
    let lastProgressUpdate = 0;
    const PROGRESS_UPDATE_INTERVAL = 300; // ms
    
    // Listen for job progress updates
    socket.on('job_progress', function(data) {
        if (data.job_id === jobId) {
            const now = Date.now();
            
            // Throttle updates for smoother animation
            if (now - lastProgressUpdate < PROGRESS_UPDATE_INTERVAL && data.status === 'running') {
                return;
            }
            lastProgressUpdate = now;
            
            console.log('Progress update:', data);
            
            // Update progress display
            document.getElementById('job-processed').textContent = data.current || 0;
            document.getElementById('job-total').textContent = data.total || 0;
            document.getElementById('job-percent').textContent = (data.percent || 0).toFixed(1);
            
            // Update progress bar with smooth animation
            const progressBar = document.getElementById('progress-bar');
            const percent = data.percent || 0;
            progressBar.style.width = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            document.getElementById('progress-bar-text').textContent = percent.toFixed(1) + '%';
            
            // Update status badge
            const statusBadge = document.getElementById('job-status');
            statusBadge.textContent = (data.status || 'running').toUpperCase();
            statusBadge.className = 'badge bg-' + (
                data.status === 'completed' ? 'success' :
                data.status === 'running' ? 'primary' :
                data.status === 'paused' ? 'warning' :
                data.status === 'cancelled' ? 'secondary' :
                data.status === 'failed' ? 'danger' : 'warning'
            );
            
            // Update control buttons based on status
            const jobControls = document.getElementById('job-controls');
            if (jobControls) {
                if (data.status === 'running') {
                    jobControls.innerHTML = `
                        <button type="button" class="btn btn-warning" id="pause-btn" onclick="pauseJob()">
                            <i class="bi bi-pause-fill"></i> Pause
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-btn" onclick="cancelJob()">
                            <i class="bi bi-x-circle-fill"></i> Cancel
                        </button>
                    `;
                } else if (data.status === 'paused') {
                    jobControls.innerHTML = `
                        <button type="button" class="btn btn-success" id="resume-btn" onclick="resumeJob()">
                            <i class="bi bi-play-fill"></i> Resume
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-btn" onclick="cancelJob()">
                            <i class="bi bi-x-circle-fill"></i> Cancel
                        </button>
                    `;
                } else {
                    // Hide controls for completed/failed/cancelled
                    jobControls.style.display = 'none';
                }
            }
            
            // Show live message
            if (data.message) {
                document.getElementById('message-text').textContent = data.message;
                document.getElementById('live-message').style.display = 'block';
            }
            
            // If completed, reload page to show final result
            if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
                setTimeout(() => location.reload(), 2000);
            }
        }
    });
    
    // Fallback: Auto-refresh if job is running and no socket updates
    {% if job.status in ['pending', 'running'] %}
    let lastUpdate = Date.now();
    socket.on('job_progress', function() {
        lastUpdate = Date.now();
    });
    
    setInterval(function() {
        // If no updates in 10 seconds, refresh page
        if (Date.now() - lastUpdate > 10000) {
            location.reload();
        }
    }, 10000);
    {% endif %}
</script>
{% endblock %}
