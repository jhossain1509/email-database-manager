{% extends "layouts/base.html" %}
{% block title %}Export Emails{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2><i class="bi bi-download"></i> Export Emails</h2>
    
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header"><h5>Export Configuration</h5></div>
                <div class="card-body">
                    <form method="POST" id="exportForm">
                        <!-- Export Type -->
                        <div class="mb-3">
                            <label for="export_type" class="form-label">Export Type</label>
                            <select class="form-select" id="export_type" name="export_type" required>
                                <option value="verified">Verified Emails Only (All Methods)</option>
                                <option value="smtp_verified">SMTP Verified Only</option>
                                <option value="unverified">Unverified Emails Only</option>
                                <option value="invalid">Invalid Emails Only</option>
                                {% if current_user.is_guest() %}
                                <option value="duplicate">Duplicate Emails (Already in Main DB)</option>
                                {% endif %}
                                <option value="all">All Emails</option>
                            </select>
                            <small class="form-text text-muted">
                                SMTP Verified: Only emails validated using SMTP ping method
                                {% if current_user.is_guest() %}<br>Duplicate: Emails that already exist in main database{% endif %}
                            </small>
                        </div>
                        
                        <!-- Batch Selection -->
                        <div class="mb-3">
                            <label for="batch_id" class="form-label">Batch (Optional)</label>
                            <select class="form-select" id="batch_id" name="batch_id">
                                <option value="">All Batches</option>
                                {% for batch in batches %}
                                <option value="{{ batch.id }}">{{ batch.name }} ({{ batch.total_count }} emails)</option>
                                {% endfor %}
                            </select>
                            {% if current_user.is_guest() %}
                            <small class="form-text text-muted">Guest users must select a specific batch</small>
                            {% endif %}
                        </div>
                        
                        <!-- Random Sample Limit -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_random_limit" name="enable_random_limit" onchange="toggleRandomLimit()">
                                <label class="form-check-label" for="enable_random_limit">
                                    Limit to Random Sample
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="random_limit_section" style="display: none;">
                            <label for="random_limit" class="form-label">Number of Emails to Export</label>
                            <input type="number" class="form-control" id="random_limit" name="random_limit" 
                                   value="5000" min="1" max="1000000" placeholder="e.g., 5000">
                            <small class="form-text text-muted">
                                Random sample will be selected from all available emails. Works with split files option.
                            </small>
                        </div>
                        
                        <!-- Quality Rating Filter -->
                        <div class="mb-3">
                            <label class="form-label">Filter by Quality Rating (Optional)</label>
                            <div class="card">
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rating_a" name="rating_filter" value="A">
                                        <label class="form-check-label" for="rating_a">
                                            <span class="badge bg-success">A</span> Excellent (80-100) - High quality emails
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rating_b" name="rating_filter" value="B">
                                        <label class="form-check-label" for="rating_b">
                                            <span class="badge bg-info">B</span> Good (60-79) - Good quality emails
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rating_c" name="rating_filter" value="C">
                                        <label class="form-check-label" for="rating_c">
                                            <span class="badge bg-warning">C</span> Fair (40-59) - Fair quality emails
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="rating_d" name="rating_filter" value="D">
                                        <label class="form-check-label" for="rating_d">
                                            <span class="badge bg-danger">D</span> Poor (0-39) - Poor quality emails
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Leave all unchecked to export all ratings</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Domain Filtering with Limits -->
                        <div class="mb-3">
                            <label class="form-label">Filter by Domains with Limits</label>
                            <div class="card">
                                <div class="card-body">
                                    {% if domain_stats %}
                                    <p class="text-muted small">Select domains and specify how many emails to export from each:</p>
                                    {% for stat in domain_stats %}
                                    <div class="row mb-2 align-items-center">
                                        <div class="col-md-1">
                                            <input type="checkbox" class="form-check-input domain-checkbox" 
                                                   id="domain_{{ loop.index }}" 
                                                   data-domain="{{ stat.domain }}"
                                                   onchange="toggleDomainLimit(this)">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="domain_{{ loop.index }}" class="form-check-label">
                                                <strong>{{ stat.domain }}</strong>
                                            </label>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge bg-info domain-count" 
                                                  data-domain="{{ stat.domain }}"
                                                  data-verified="{{ stat.verified_available }}"
                                                  data-smtp-verified="{{ stat.smtp_verified_available|default(0) }}"
                                                  data-unverified="{{ stat.unverified_available }}"
                                                  data-invalid="{{ stat.invalid_available }}"
                                                  data-all="{{ stat.all_available }}">
                                                {{ stat.all_available }} available
                                            </span>
                                            <small class="text-muted">({{ stat.total }} total)</small>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control form-control-sm domain-limit" 
                                                   id="limit_{{ stat.domain }}" 
                                                   data-domain="{{ stat.domain }}"
                                                   placeholder="Limit"
                                                   min="1" 
                                                   max="{{ stat.all_available }}"
                                                   disabled>
                                        </div>
                                    </div>
                                    {% endfor %}
                                    {% else %}
                                    <p class="text-muted">No emails available for export</p>
                                    {% endif %}
                                    <input type="hidden" name="domain_limits" id="domain_limits">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Format -->
                        <div class="mb-3">
                            <label for="export_format" class="form-label">Export Format</label>
                            <select class="form-select" id="export_format" name="export_format">
                                <option value="csv">CSV (Full Details)</option>
                                <option value="txt">TXT (Email List Only)</option>
                            </select>
                        </div>
                        
                        <!-- Custom Fields (for CSV) -->
                        <div class="mb-3" id="custom_fields_section">
                            <label for="custom_fields" class="form-label">Custom CSV Fields (Optional)</label>
                            <input type="text" class="form-control" id="custom_fields" name="custom_fields" 
                                   placeholder="email,domain,quality_score,uploaded_at">
                            <small class="form-text text-muted">
                                Leave empty for default fields. Available: email, domain, quality_score, uploaded_at, domain_category, is_valid
                            </small>
                        </div>
                        
                        <!-- File Split Options -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="split_files" name="split_files" onchange="toggleSplitSize()">
                                <label class="form-check-label" for="split_files">
                                    Split into multiple files
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3" id="split_size_section" style="display: none;">
                            <label for="split_size" class="form-label">Records per file</label>
                            <input type="number" class="form-control" id="split_size" name="split_size" 
                                   value="10000" min="100" max="100000">
                            <small class="form-text text-muted">Split export into files with this many records each</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" onclick="return prepareDomainLimits()">
                            <i class="bi bi-download"></i> Start Export
                        </button>
                        <a href="{{ url_for('dashboard.index') }}" class="btn btn-secondary">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header"><h5>Export Info</h5></div>
                <div class="card-body">
                    <p><strong>Note:</strong> Exports automatically exclude:</p>
                    <ul>
                        <li>Emails in suppression list</li>
                        <li>Emails marked as opted-out</li>
                    </ul>
                    <p><strong>Large exports:</strong> will be processed in the background. You'll be able to download once complete.</p>
                    <p><strong>Download History:</strong> After export, you can re-download from your <a href="{{ url_for('email.download_history') }}">Download History</a></p>
                </div>
            </div>
            
            {% if current_user.is_guest() %}
            <div class="alert alert-warning mt-3">
                <i class="bi bi-info-circle"></i>
                <strong>Guest User:</strong> You can only export from your own uploaded batches.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleDomainLimit(checkbox) {
    const domain = checkbox.dataset.domain;
    const limitInput = document.getElementById('limit_' + domain);
    limitInput.disabled = !checkbox.checked;
    if (!checkbox.checked) {
        limitInput.value = '';
    }
}

function toggleSplitSize() {
    const splitFiles = document.getElementById('split_files').checked;
    document.getElementById('split_size_section').style.display = splitFiles ? 'block' : 'none';
}

function toggleRandomLimit() {
    const enableRandomLimit = document.getElementById('enable_random_limit').checked;
    document.getElementById('random_limit_section').style.display = enableRandomLimit ? 'block' : 'none';
}

function updateDomainCounts() {
    const exportType = document.getElementById('export_type').value;
    const domainCounts = document.querySelectorAll('.domain-count');
    
    domainCounts.forEach(badge => {
        const domain = badge.dataset.domain;
        let count = 0;
        
        switch(exportType) {
            case 'verified':
                count = parseInt(badge.dataset.verified);
                break;
            case 'smtp_verified':
                count = parseInt(badge.dataset.smtpVerified || 0);
                break;
            case 'unverified':
                count = parseInt(badge.dataset.unverified);
                break;
            case 'invalid':
                count = parseInt(badge.dataset.invalid);
                break;
            case 'all':
            default:
                count = parseInt(badge.dataset.all);
                break;
        }
        
        badge.textContent = count + ' available';
        
        // Update limit input max value
        const limitInput = document.getElementById('limit_' + domain);
        if (limitInput) {
            limitInput.max = count;
            // Clear value if it exceeds new max
            if (limitInput.value && parseInt(limitInput.value) > count) {
                limitInput.value = count;
            }
        }
    });
}

async function updateDomainStatsByBatch() {
    const batchId = document.getElementById('batch_id').value;
    const exportType = document.getElementById('export_type').value;
    
    // If no batch selected, just update counts normally
    if (!batchId) {
        updateDomainCounts();
        return;
    }
    
    try {
        const response = await fetch(`/api/export/domain-stats?batch_id=${batchId}&export_type=${exportType}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error fetching domain stats:', data.error);
            return;
        }
        
        // Update domain counts based on API response
        const domainCounts = document.querySelectorAll('.domain-count');
        domainCounts.forEach(badge => {
            const domain = badge.dataset.domain;
            const stat = data.domain_stats.find(s => s.domain === domain);
            
            if (stat) {
                badge.textContent = stat.count + ' available';
                
                // Update limit input max value
                const limitInput = document.getElementById('limit_' + domain);
                if (limitInput) {
                    limitInput.max = stat.count;
                    // Clear value if it exceeds new max
                    if (limitInput.value && parseInt(limitInput.value) > stat.count) {
                        limitInput.value = stat.count;
                    }
                }
            } else {
                // Domain not available in this batch
                badge.textContent = '0 available';
                const limitInput = document.getElementById('limit_' + domain);
                if (limitInput) {
                    limitInput.max = 0;
                    limitInput.value = '';
                    limitInput.disabled = true;
                }
                // Uncheck the checkbox
                const checkbox = document.querySelector(`.domain-checkbox[data-domain="${domain}"]`);
                if (checkbox) {
                    checkbox.checked = false;
                }
            }
        });
    } catch (error) {
        console.error('Error updating domain stats:', error);
        // Fallback to local update
        updateDomainCounts();
    }
}

function prepareDomainLimits() {
    const checkboxes = document.querySelectorAll('.domain-checkbox:checked');
    const limits = [];
    let hasError = false;
    
    checkboxes.forEach(cb => {
        const domain = cb.dataset.domain;
        const limitInput = document.getElementById('limit_' + domain);
        const limit = limitInput.value;
        
        if (!limit || limit <= 0) {
            // If checkbox is selected but no valid limit, show error
            alert('Please enter a valid limit for ' + domain + ' or uncheck the domain');
            hasError = true;
            return false;
        }
        
        limits.push(domain + ':' + limit);
    });
    
    if (hasError) {
        event.preventDefault();
        return false;
    }
    
    document.getElementById('domain_limits').value = limits.join(',');
    return true;
}

// Update domain counts when export type changes
document.getElementById('export_type').addEventListener('change', function() {
    const batchId = document.getElementById('batch_id').value;
    if (batchId) {
        updateDomainStatsByBatch();
    } else {
        updateDomainCounts();
    }
});

// Update domain counts when batch changes
document.getElementById('batch_id').addEventListener('change', function() {
    updateDomainStatsByBatch();
});

// Hide custom fields when TXT format is selected
document.getElementById('export_format').addEventListener('change', function() {
    const customFieldsSection = document.getElementById('custom_fields_section');
    customFieldsSection.style.display = this.value === 'csv' ? 'block' : 'none';
});

// Initialize domain counts on page load
document.addEventListener('DOMContentLoaded', updateDomainCounts);
</script>
{% endblock %}
